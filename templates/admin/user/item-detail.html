<ul class="nav nav-tabs" id="member-tab">
  <li class="active">
    <a href="#Account" data-toggle="tab">Account</a>
  </li>
  <li>
    <a href="#Password" data-toggle="tab">Password</a>
  </li>
  <li>
    <a href="#Profile" data-toggle="tab">Profile</a>
  </li>
  <li>
    <a href="#Role" data-toggle="tab">Roles</a>
  </li>
</ul>
<div class="tab-content popup">
  <div id="Account" class="tab-pane fade active in">
    <ul id="account-info">
      <li class="info-item item">
        <label>User Name</label>
        <input type="text" name="username" id="overview-username" value="{{user.username}}" />
      </li>
      <li class="info-item item">
        <label>Age</label>
        <input type="number" name="age" value="{{user.age}}" id="overview-age" />
      </li>
      <li class="info-item item">
        <label>Gender</label>
        <select name="gender" id="overview-gender">
          <option value="0" {% if user.gender == 0 %}selected="selected"{%endif%}>Secrete</option>
          <option value="1" {% if user.gender == 1 %}selected="selected"{%endif%}>Boy</option>
          <option value="2" {% if user.gender == 2 %}selected="selected"{%endif%}>Girl</option>
        </select>
      </li>
      <li class="info-item item">
        <label>UserType</label>
        <select name="usertype" id="overview-usertype">
          {% for type in type_list%}
          <option value="{{type.id}}" {% if type.id == user.usertype.id %} selected="selected" {% endif %}>{{type.typename}}</option>
          {% endfor %}
        </select>
      </li>
      <li class="info-item item">
        <label>Email</label>
        <input type="email" name="email" value="{{user.email}}" id="overview-email" />
      </li>
      <li class="info-item item">
        <label>Address</label>
        <input type="text" name="address" value="{{user.address}}" id="overview-address" />
      </li>
      <li class="info-item item">
        <label></label>
        <a class="edit btn btn-info"  id="overview-submit">
          <i class="icon-pencil"></i>
          Change
        </a>
        <a class="btn btn-danger" id="delete">
          <i class="icon-trash icon-white"></i>
          Delete
        </a>
      </li>
    </ul>
  </div>
  <div id="Password" class="tab-pane fade">
    <ul id="password-info">
      <li class="info-item item">
        <label>User Name</label>
        <input type="text" name="username" value="{{user.username}}" disabled/>
      </li>
      <li class="info-item item">
        <label>Password</label>
        <input type="password" name="password" id="psw-1" />
      </li>
      <li class="info-item item">
        <label>Repeat</label>
        <input type="password" name="password" id="psw-2" />
      </li>
      <li class="info-item item">
        <label></label>
        <a class="edit btn btn-info" id="psw-submit">
          <i class="icon-pencil"></i>
          Change
        </a>
      </li>
    </ul>
  </div>
  <div id="Profile" class="tab-pane fade">
    Profile
  </div>
  <div id="Role" class="tab-pane fade">
    <ul id="role-info">
      <li class="info-item item">
        <label>Roles</label>
        <select size="10" multiple="multiple" name="roles" id="role-all">
          {% for role in roles %}
          <option {%if user.contains_role(role.rolename)%} selected="selected"{% endif%} value="{{role.id}}">{{role.rolename}}</option>
          {% endfor %}
        </select>
      </li>
      <li class="info-item item">
        <label></label>
        <a class="edit btn btn-info" id="role-submit">
          <i class="icon-pencil"></i>
          Change
        </a>
      </li>
    </ul>
    
  </div>
</div>
</article>
<script>
$(document).ready(function() {
$("#overview-submit").click(function() {
  var data = {
    username : $("#overview-username").val(),
    age : $("#overview-age").val(),
    gender: $("#overview-gender").val(),
    email: $("#overview-email").val(),
    address: $("#overview-address").val(),
    type: $("#overview-usertype").val()
  };
  user.update({{user.id}}, data).done(function(json) {
    $("#table-item-{{user.id}}").find(".item-name").text(json.user.username);
    $.fancybox.close();
  });
});
$("#psw-submit").click(function() {
  var p1 = $("#psw-1").val();
  var p2 = $("#psw-2").val();
  if (p1 != p2) {
    error.top_message("password not match");
    return;
  }
  if (p1 == "") {
    error.top_message("password empty");
    return;
  }
  var data = {
    password: p1 
  };
  user.update({{user.id}}, data).done($.fancybox.close);
});
$("#role-submit").click(function() {
  var user_role = [{% for role in user.roles %}{{role.id}},{% endfor %} 0]; 
  user_role.pop();
  var data = {
    roles: {
      add:[],
      remove:[]
    }
  };
  var r_list = $("#role-all").val();
  for (var r in r_list) {
    if (r == "remove")
      continue;
    var t = parseInt(r_list[r]);
    var i = user_role.indexOf(t);
    if (i == -1) {
      if (t != null && t != NaN)
        data.roles.add.push(t);
    } else {
      user_role.remove(i);
    }
  }
  data.roles.remove = user_role;
  user.update({{user.id}}, data).done($.fancybox.close);
});

$("#delete").click(function() {
  user.delete({{user.id}}).done(function(json) {
    $.fancybox.close();
    $("#table-item-{{user.id}}").fadeOut('slow').remove();
  });
});
});
</script>
