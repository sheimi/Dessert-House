{% import 'imports/forms.html' as forms %}
<div id="dessert_list"> 
  {% for d in dessert_list%}
  <div class="row dessert-item">
    {{forms.bs_img('/static/img/dessert/'+d.img+'.png', href='/index/dessert/'+d.id|string, class='span3 dessert-img')}}
    <div class="span5">
      <h6>Dessert Name: <b>{{d.dname}}</b></h6>
      <hr/>
      <p>
      {{d.des}}
      </p>
      <hr/>
      Price: <b>${{d.price}}</b>
    </div>
    <div class="dessert-op span3">
      {% if user %}
      {% call forms.bs_control_group(for='num-'+d.id|string, label='Number: ')  %}
        {{ forms.input_num("num", "num-"+d.id|string, max=d.num, ph="Number") }}
      {% endcall %}
      <div class="form-actions">
        {{ forms.bs_btn('Buy', btype='success', class='btn-buy', itype='shopping-cart', 
          other='data-id="'+d.id|string+'" data-price="'+d.price|string+'"')}}
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        {{ forms.bs_btn('Reserve', btype='info', class='btn-reserve', itype='inbox', 
          other='data-id="'+d.id|string+'" data-price="'+d.price|string+'"')}}
      </div>
      {% endif %}
    </div>
  </div>
  {% if not loop.last %}
  <hr/>
  {% endif %}
  {% endfor %}
</div>

<script>
$(document).ready(function() {

$(".dessert-img").click(function(e) {
  e.preventDefault()
  $.fancy_ajax($(this).attr('href'))
})

function add_item(data) {
  send_json({
    url : '/ajax/item/additem', 
    method: 'POST', 
    data: data.data,
    }).done(function(json) {
      if (json.success) {
        success.top_message(data.s_msg)
      } else {
        error.top_message('Add Failed')
      }
    })
}

$(".btn-buy").click(function() {
  var id = $(this).attr("data-id")
  var num = $("#num-"+id).val()
  var price = $(this).attr("data-price")
  if (!num || num == '0') {
    error.top_message('Dessert Number Error')
    return
  }
  num = parseInt(num)
  id = parseInt(id)
  add_item({
    data : {num: num, dessert:id, order: order.id, price: price},
    s_msg: "Dessert Has Add To Your Cart"
  })
  order.refresh_cart()
  $("#num-"+id).val("")
  var max = parseInt($("#num-"+id).attr("max"))
  $("#num-"+id).attr("max", max-num)
})


$(".btn-reserve").click(function() {
  var id = $(this).attr("data-id")
  var num = $("#num-"+id).val()
  var price = $(this).attr("data-price")
  if (!num || num == '0') {
    error.top_message('Dessert Number Error')
    return
  }
  num = parseInt(num)
  id = parseInt(id)

  add_item({  
    data : {num: num, dessert:id, order: reservation.id, price: price},  
    s_msg: "Dessert Added To Your Reservation"
  })
  reservation.refresh_r()
  $("#num-"+id).val("")
})

})
</script>
